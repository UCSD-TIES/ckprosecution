{% extends "base.html" %}

{% block title %}Coastkeeper: Report Database and Analytics{% endblock %}

{% block htmlhead %}
    <link rel="stylesheet" href="{{ STATIC_URL }}coastkeeper/css/datepicker.css" />
    <script type="text/javascript" src="{{ STATIC_URL }}coastkeeper/JS/json2.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}coastkeeper/JS/bootstrap-datepicker.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}coastkeeper/JS/jquery.validate.min.js"></script>
    <style>
        .createtable {text-align:left;}
        .button { margin: 4px 10px; }
        .line { border-bottom: 1px solid black; }
        .close { float: right; }
        .notice { color: #F4811F; padding-top: 25px; }
        .newlook {background-color:white;}
        .actions {margin-left:10px;}
        .actions { margin-bottom: 15px; }
        .title {margin-left: 10px;margin-top: 25px;margin-bottom:0px; font-size:2em;}
        .form-horizontal .form-group { margin-bottom: 2px;}
    </style>
{% endblock %}

{% block content %}
    <span class="title">Reports</span>

    {% block actions %}
        {% if user.is_authenticated %}
        <div class="navbar" role="navigation">
            <ul class="nav navbar-nav">
                <li>
                    <button data-target="#create_report" data-toggle="modal" class="navbar-btn btn btn-default">
                        <span class="glyphicon glyphicon-plus"></span> New Report
                    </button>
                </li>
                <li>
                    <form action="/reports/filter_by_date/" method="get" class="navbar-form">
                    {% csrf_token %}
                        <div class="form-group">
                            <input name="start_date" size=9 class="form-control" id="datepicker_start" placeholder="From">
                        </div>
                        <div class="form-group">
                            <input name="end_date" size=9 class="form-control" id="datepicker_end" placeholder="To">
                        </div>
                        <button type="submit" value="Submit" class="btn btn-default">
                            <span class="glyphicon glyphicon-filter"></span> Filter by Date
                        </button>
                    </form>
                </li>
                <li>
                    <form action="/reports/search/" method="get" class="navbar-form">
                    {% csrf_token %}
                        <div class="form-group">
                            <input name="q" class="form-control" class="input-medium search-query" placeholder="Search reports">
                        </div>
                        <button type="submit" value="Submit" class="btn btn-default">
                            <span class="glyphicon glyphicon-search"></span> Search
                        </button>
                    </form>
                </li>
            </ul>
        </div>
        {% endif %}
    {% endblock %}

    <div class="reporttable table-responsive">
	    <table class="table table-condensed" id="expenselist">
            <thead>
                <tr>
                    <th>
                        Crime Date<a href="{% url rank rank_by='crime_date' reverse='true' %}"><i class="glyphicon glyphicon-arrow-up"></i></a>
                            <a href="{% url rank rank_by='crime_date' reverse='false' %}"><i class="glyphicon glyphicon-arrow-down"></i></a>
                    </th>
                    <th>
                        Resolve Days<a href="{% url rank rank_by='resolve_days' reverse='true' %}"><i class="glyphicon glyphicon-arrow-up"></i></a>
                            <a href="{% url rank rank_by='resolve_days' reverse='false' %}"><i class="glyphicon glyphicon-arrow-down"></i></a>
                    </th>
                    <th>
                        Suspects<a href="{% url rank rank_by='num_involved' reverse='true' %}"><i class="glyphicon glyphicon-arrow-up"></i></a>
                            <a href="{% url rank rank_by='num_involved' reverse='false' %}"><i class="glyphicon glyphicon-arrow-down"></i></a>
                    </th>
                    <th>
                        Creature<a href="{% url rank rank_by='creature' reverse='true' %}"><i class="glyphicon glyphicon-arrow-up"></i></a>
                            <a href="{% url rank rank_by='creature' reverse='false' %}"><i class="glyphicon glyphicon-arrow-down"></i></a>
                    </th>
                    <th>
                        Location<a href="{% url rank rank_by='location' reverse='true' %}"><i class="glyphicon glyphicon-arrow-up"></i></a>
                            <a href="{% url rank rank_by='location' reverse='false' %}"><i class="glyphicon glyphicon-arrow-down"></i></a>
                    </th>
                    <th>
                        Trial Location<a href="{% url rank rank_by='trial_location' reverse='true' %}"><i class="glyphicon glyphicon-arrow-up"></i></a>
                            <a href="{% url rank rank_by='trial_location' reverse='false' %}"><i class="glyphicon glyphicon-arrow-down"></i></a>
                    </th>
                    <th>
                        Fine<a href="{% url rank rank_by='fine' reverse='true' %}"><i class="glyphicon glyphicon-arrow-up"></i></a>
                            <a href="{% url rank rank_by='fine' reverse='false' %}"><i class="glyphicon glyphicon-arrow-down"></i></a>
                    </th>
                    <th>
                        Jail<a href="{% url rank rank_by='jail_time' reverse='true' %}"><i class="glyphicon glyphicon-arrow-up"></i></a>
                            <a href="{% url rank rank_by='jail_time' reverse='false' %}"><i class="glyphicon glyphicon-arrow-down"></i></a>
                    </th>
                    <th>
                        MPA<a href="{% url rank rank_by='mpa' reverse='true' %}"><i class="glyphicon glyphicon-arrow-up"></i></a>
                            <a href="{% url rank rank_by='mpa' reverse='false' %}"><i class="glyphicon glyphicon-arrow-down"></i></a>
                    </th>
                    <th>
                        Update Date<a href="{% url rank rank_by='update_date' reverse='true' %}"><i class="glyphicon glyphicon-arrow-up"></i></a>
                            <a href="{% url rank rank_by='update_date' reverse='false' %}"><i class="glyphicon glyphicon-arrow-down"></i></a>
                    </th>
                    <th> </th>
                </tr>
            </thead>
            <tbody id="table_body">
                {% for item in reports %}
                    <tr id="{{ item.id }}">
                        <td>{{ item.crime_date }}</td>
                        <td>{{ item.resolve_days }}</td>
                        <td>{{ item.num_involved }}</td>
                        <td>{{ item.creature }}</td>
                        <td>{{ item.location }}</td>
                        <td>{{ item.trial_location }}</td>
                        <td>{{ item.fine }}</td>
                        <td>{{ item.jail_time }}</td>
                        <td>{{ item.mpa }}</td>
                        <td>{{ item.update_date }}</td>
                        <td><a href="{% url detail report_id=item.id %}">Details</a></td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="create_report" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h3>Create New Report</h3>
                </div>
                <div class="modal-body">
                    <form id="create_report_form" class="form-horizontal" method="POST">{% csrf_token %}
                        <div class="form-group">
                            <label for="id_crime_date" class="col-sm-3 control-label" >Crime date</label>
                            <div class="col-sm-9">
                                <input class="form-control" name="crime_date" type="text" id="id_crime_date"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="id_resolve_days" class="col-sm-3 control-label" >Resolve day</label>
                            <div class="col-sm-9">
                                <input class="form-control" name="resolve_days" type="text" id="id_resolve_days"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="id_num_involved" class="col-sm-3 control-label" >Num involved:</label>
                            <div class="col-sm-9">
                                <input class="form-control" name="num_involved" type="text" id="id_num_involved"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="id_creature" class="col-sm-3 control-label" >Creature</label>
                            <div class="col-sm-9">
                                <input class="form-control" name="creature" type="text" id="id_creature"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="id_location" class="col-sm-3 control-label" >Location</label>
                            <div class="col-sm-9">
                                <input class="form-control" name="location" type="text" id="id_location"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="id_trial_location" class="col-sm-3 control-label" >Trial location</label>
                            <div class="col-sm-9">
                                <input class="form-control" name="trial_location" type="text" id="id_trial_location"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="id_violation_description" class="col-sm-3 control-label" >Violation description</label>
                            <div class="col-sm-9">
                                <textarea class="form-control" name="violation_description" rows=5 id="id_violation_description"/></textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="id_fine" class="col-sm-3 control-label" >Fine</label>
                            <div class="col-sm-9">
                                <input class="form-control" name="fine" type="text" id="id_fine"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-offset-3 col-sm-9">
                                <label for="id_jail_time" class="checkbox">
                                    <input name="jail_time" type="checkbox" id="id_jail_time"> Jail Time
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-offset-3 col-sm-9">
                                <label for="id_mpa" class="checkbox">
                                    <input name="mpa" type="checkbox" id="id_mpa"> MPA
                                </label>
                            </div>
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" id="create_button">Create Report</button>
                    <button class="btn btn-warning" data-dismiss="modal">Close</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        $.validator.setDefaults({
            errorElement: "span",
            errorClass: "help-block",
            highlight: function (element, errorClass, validClass) {
                $(element).closest('.form-group').addClass('has-error');
            },
            unhighlight: function (element, errorClass, validClass) {
                $(element).closest('.form-group').removeClass('has-error');
            },
            errorPlacement: function (error, element) {
                if (element.parent('.input-group').length || element.prop('type') === 'checkbox' || element.prop('type') === 'radio') {
                    error.insertAfter(element.parent());
                } else {
                    error.insertAfter(element);
                }
            }
        });
        
        $.validator.addMethod(
            "regex",
            function(value, element, regexp) {
                var re = new RegExp(regexp);
//                 console.log(re.test(value))
                return this.optional(element) || re.test(value);
            },
            "Please check your input."
        );

        $(document).ready(function(){
            $( "#datepicker_start, #datepicker_end, #id_crime_date" ).datepicker({format: "yyyy-mm-dd"});
            var container = $('div.error_container');
            $("#create_report_form").validate({
                errorContainer: container,
		          errorLabelContainer: $("ol", container),
		          wrapper: 'li',
                rules: {
                    crime_date: {
                        required: true
                    },
                    resolve_days: {
                        required: true,
                        digits: true
                    },
                    creature: {
                        required: true,
                        regex: /^([a-zA-Z]\s?)+$/
                    },
                    num_involved: {
                        required: true,
                        digits: true
                    },
                    location: {
                        required: true,
                        regex: /^\-?[0-9]{1,3}(\.[0-9]{1,3})?,\s?\-?[0-9]{1,3}(\.[0-9]{1,3})?$/
                    },
                    trial_location: {
                        required: true,
                        regex: /^([a-zA-Z]\s?)+$/
                    },
                    violation_description: {
                        required: true
                    },
                    fine: {
                        required: true,
                        number: true
                    }
                },
                messages: {
                    creature: "Enter Creature",
                    location: "Coordinates (ex 123.456, -189.012)",
                    trial_location: "Enter Trial Location",
                    violation_description: "Enter Violation Description"
                },
//                 errorPlacement: function(error, element) {
//                     error.appendTo( element.parent("td").next("td") );
//                 }
            });
        });
    </script>

    {% if success %}
        <div id="create_success" class="modal hide fade">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h3>Success!</h3>
            </div>
            <div class="modal-body">
                Successfully created Report.
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-primary" data-dismiss="modal">Okay</a>
            </div>
        </div>

        <script type="text/javascript">
            $('#create_success').modal({backdrop:false});
        </script>
    {% endif %}

    <div id="edit_report" class="modal hide fade">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h3>Edit Report</h3>
        </div>
        <div class="modal-body">
            <form action="" class="form-inline" method="POST">{% csrf_token %}
                <table class="edittable" style ="text-align:left">
                    <tr>
                        <th><label for="id_crime_date">Crime date:</label></th>
                        <td><input class="form-control" id="id_crime_date" name="crime_date" type="text"></td>
                    </tr>
                    <tr>
                        <th><label for="id_resolve_days">Resolve days:</label></th>
                        <td><input class="form-control" id="id_resolve_days" name="resolve_days" type="text"></td>
                    </tr>
                    <tr>
                        <th><label for="id_num_involved">Num involved:</label></th>
                        <td><input class="form-control" id="id_num_involved" name="num_involved" type="text"></td>
                    </tr>
                    <tr>
                        <th><label for="id_creature">Creature:</label></th>
                        <td><input class="form-control" id="id_creature" maxlength="45" name="creature" type="text"></td>
                    </tr>
                    <tr>
                        <th><label for="id_location">Location:</label></th>
                        <td><input class="form-control" id="id_location" maxlength="45" name="location" type="text"></td>
                    </tr>
                    <tr>
                        <th><label for="id_trial_location">Trial location:</label></th>
                        <td><input class="form-control" id="id_trial_location" maxlength="45" name="trial_location" type="text"></td>
                    </tr>
                    <tr>
                        <th><label for="id_violation_description">Violation description:</label></th>
                        <td><textarea class="form-control" id="id_violation_description" name="violation_description" type="text"></td>
                    </tr>
                    <tr>
                        <th><label for="id_fine">Fine:</label></th>
                        <td><input class="form-control" id="id_fine" name="fine" type="text"></td>
                    </tr>
                    <tr>
                        <th><label for="id_update_date">Update date:</label></th>
                        <td><input class="form-control" id="id_update_date" name="update_date" type="text"></td>
                    </tr>
                    <tr>
                        <th><label for="id_jail_time">Jail time:</label></th>
                        <td><input id="id_jail_time" name="jail_time" type="checkbox"></td>
                    </tr>
                    <tr>
                        <th><label for="id_mpa">Mpa:</label></th>
                        <td><input id="id_mpa" name="mpa" type="checkbox"></td>
                    </tr>
                    <tr style="display:none">
                        <th><label for="id_report">Mpa:</label></th>
                        <td><input id="id_report" name="report" type="text"></td>
                    </tr>
                </table>
        </div>
        <div class="modal-footer">
            <a href="#" class="btn" data-dismiss="modal">Close</a>
            <button type="submit" class="btn btn-primary">Update Report</button>
            </form>
        </div>
    </div>

<!--<script type="text/javascript">

        {% block main_javascript %}

        $('.table tr').click(function(){
            $(this);
            $('#edit_report').modal({backdrop:false});
            $('.edittable input#id_report').val($(this).attr('id'));
            $('.edittable input#id_crime_date').val($($(this).find('td')[0]).text());
            $('.edittable input#id_resolve_days').val($($(this).find('td')[1]).text());
            $('.edittable input#id_num_involved').val($($(this).find('td')[2]).text());
            $('.edittable input#id_creature').val($($(this).find('td')[3]).text());
            $('.edittable input#id_location').val($($(this).find('td')[4]).text());
            $('.edittable input#id_trial_location').val($($(this).find('td')[5]).text());
            $('.edittable input#id_violation_description').val($($(this).find('td')[6]).text());
            $('.edittable input#id_fine').val($($(this).find('td')[7]).text());
            $('.edittable input#id_update_date').val($($(this).find('td')[8]).text());
            if($($(this).find('td')[9]).text() == 'True') {
                $(".edittable input#id_jail_time").attr('checked', true);
            }
            else {
                $(".edittable input#id_jail_time").attr('checked', false);
            }
            $('.edittable input#id_jail_time').val($($(this).find('td')[0]).text());
            $('.edittable input#id_mpa').val($($(this).find('td')[0]).text());
        });

        $('#create_report').modal({backdrop:false});
        $('#create_submit').click(function(){$('#invis').submit();});
        $('#create_report').modal('hide');

        {% endblock %}
    </script>
-->
{% endblock %}
